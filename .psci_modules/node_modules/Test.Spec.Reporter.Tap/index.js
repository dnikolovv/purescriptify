"use strict";
var Control_Applicative = require("../Control.Applicative/index.js");
var Control_Bind = require("../Control.Bind/index.js");
var Control_Monad_State_Class = require("../Control.Monad.State.Class/index.js");
var Control_Monad_State_Trans = require("../Control.Monad.State.Trans/index.js");
var Control_Monad_Writer_Trans = require("../Control.Monad.Writer.Trans/index.js");
var Data_Either = require("../Data.Either/index.js");
var Data_Functor = require("../Data.Functor/index.js");
var Data_Identity = require("../Data.Identity/index.js");
var Data_Maybe = require("../Data.Maybe/index.js");
var Data_Monoid = require("../Data.Monoid/index.js");
var Data_Semigroup = require("../Data.Semigroup/index.js");
var Data_Show = require("../Data.Show/index.js");
var Data_String_Common = require("../Data.String.Common/index.js");
var Data_String_Regex = require("../Data.String.Regex/index.js");
var Data_Unit = require("../Data.Unit/index.js");
var Effect_Exception = require("../Effect.Exception/index.js");
var Test_Spec_Console = require("../Test.Spec.Console/index.js");
var Test_Spec_Reporter_Base = require("../Test.Spec.Reporter.Base/index.js");
var Test_Spec_Result = require("../Test.Spec.Result/index.js");
var Test_Spec_Runner_Event = require("../Test.Spec.Runner.Event/index.js");
var Test_Spec_Summary = require("../Test.Spec.Summary/index.js");

// create a TAP-safe error msg
var escTitle = (function () {
    var rex = Data_Maybe.fromJust()(Data_Either.hush(Data_String_Regex.regex("#")(Data_String_Regex.parseFlags("g"))));
    return Data_String_Regex.replace(rex)("");
})();

// create a TAP-safe title
var escMsg = (function () {
    var rex = Data_Maybe.fromJust()(Data_Either.hush(Data_String_Regex.regex("^")(Data_String_Regex.parseFlags("gm"))));
    return Data_String_Regex.replace(rex)("  ");
})();
var tapReporter = Test_Spec_Reporter_Base.defaultReporter(1)(function (v) {
    if (v instanceof Test_Spec_Runner_Event.Start) {
        return Test_Spec_Console.tellLn(Control_Monad_State_Trans.monadWriterStateT(Control_Monad_Writer_Trans.monadWriterWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))("1.." + Data_Show.show(Data_Show.showInt)(v.value0));
    };
    if (v instanceof Test_Spec_Runner_Event.Pending) {
        return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(Control_Monad_State_Class.get(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity))))(function (n) {
            return Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(Test_Spec_Console.tellLn(Control_Monad_State_Trans.monadWriterStateT(Control_Monad_Writer_Trans.monadWriterWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))("ok " + (Data_Show.show(Data_Show.showInt)(n) + (" " + (escTitle(v.value1) + " # SKIP -")))))(function () {
                return Control_Monad_State_Class.modify_(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(function (v1) {
                    return v1 + 1 | 0;
                });
            });
        });
    };
    if (v instanceof Test_Spec_Runner_Event.TestEnd && v.value2 instanceof Test_Spec_Result.Success) {
        return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(Control_Monad_State_Class.get(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity))))(function (n) {
            return Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(Test_Spec_Console.tellLn(Control_Monad_State_Trans.monadWriterStateT(Control_Monad_Writer_Trans.monadWriterWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))("ok " + (Data_Show.show(Data_Show.showInt)(n) + (" " + escTitle(v.value1)))))(function () {
                return Control_Monad_State_Class.modify_(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(function (v1) {
                    return v1 + 1 | 0;
                });
            });
        });
    };
    if (v instanceof Test_Spec_Runner_Event.TestEnd && v.value2 instanceof Test_Spec_Result.Failure) {
        return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(Control_Monad_State_Class.get(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity))))(function (n) {
            return Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(Test_Spec_Console.tellLn(Control_Monad_State_Trans.monadWriterStateT(Control_Monad_Writer_Trans.monadWriterWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))("not ok " + (Data_Show.show(Data_Show.showInt)(n) + (" " + escTitle(v.value1)))))(function () {
                return Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(Test_Spec_Console.tellLn(Control_Monad_State_Trans.monadWriterStateT(Control_Monad_Writer_Trans.monadWriterWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(escMsg(Effect_Exception.message(v.value2.value0))))(function () {
                    return Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))((function () {
                        var v1 = Effect_Exception.stack(v.value2.value0);
                        if (v1 instanceof Data_Maybe.Nothing) {
                            return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(Data_Unit.unit);
                        };
                        if (v1 instanceof Data_Maybe.Just) {
                            return Test_Spec_Console.tellLn(Control_Monad_State_Trans.monadWriterStateT(Control_Monad_Writer_Trans.monadWriterWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(Data_String_Common.joinWith("\x0a")(Data_Functor.map(Data_Functor.functorArray)(Data_Semigroup.append(Data_Semigroup.semigroupString)("    "))(Data_String_Common.split("\x0a")(v1.value0))));
                        };
                        throw new Error("Failed pattern match at Test.Spec.Reporter.Tap (line 39, column 5 - line 41, column 83): " + [ v1.constructor.name ]);
                    })())(function () {
                        return Control_Monad_State_Class.modify_(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(function (v1) {
                            return v1 + 1 | 0;
                        });
                    });
                });
            });
        });
    };
    if (v instanceof Test_Spec_Runner_Event.End) {
        var v1 = Test_Spec_Summary.summarize(v.value0);
        return Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(Test_Spec_Console.tellLn(Control_Monad_State_Trans.monadWriterStateT(Control_Monad_Writer_Trans.monadWriterWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))("# tests " + Data_Show.show(Data_Show.showInt)((v1.failed + v1.passed | 0) + v1.pending | 0)))(function () {
            return Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(Test_Spec_Console.tellLn(Control_Monad_State_Trans.monadWriterStateT(Control_Monad_Writer_Trans.monadWriterWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))("# pass " + Data_Show.show(Data_Show.showInt)(v1.passed + v1.pending | 0)))(function () {
                return Test_Spec_Console.tellLn(Control_Monad_State_Trans.monadWriterStateT(Control_Monad_Writer_Trans.monadWriterWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))("# fail " + Data_Show.show(Data_Show.showInt)(v1.failed));
            });
        });
    };
    return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Writer_Trans.monadWriterT(Data_Monoid.monoidString)(Data_Identity.monadIdentity)))(Data_Unit.unit);
});
module.exports = {
    tapReporter: tapReporter
};
